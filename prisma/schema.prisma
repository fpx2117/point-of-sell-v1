generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * ENUMS
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */

enum UserRole {
  ADMIN
  SUPERVISOR
  VENDEDOR
}

enum PaymentMethod {
  EFECTIVO
  TARJETA
  TRANSFERENCIA
}

enum MovementType {
  ENTRADA
  SALIDA
  AJUSTE
}

enum NotificationType {
  STOCK_BAJO
  STOCK_AGOTADO
  VENCIMIENTO
  VENTA
  CAJA
  SISTEMA
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * USUARIOS / SESIONES / PERMISOS
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(VENDEDOR)
  active    Boolean  @default(true)
  branchId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch             Branch?             @relation(fields: [branchId], references: [id], onDelete: SetNull)
  sales              Sale[]
  inventoryMovements InventoryMovement[]
  cashRegisters      CashRegister[]
  auditLogs          AuditLog[]
  notifications      Notification[]
  workSchedules      WorkSchedule[]
  sessionLogs        SessionLog[]
  reports            Report[]

  @@index([branchId])
  @@index([role])
  @@index([active])
}

model RolePermission {
  id        String   @id @default(cuid())
  role      UserRole
  resource  String
  canRead   Boolean  @default(true)
  canWrite  Boolean  @default(false)
  canDelete Boolean  @default(false)

  @@unique([role, resource])
}

model SessionLog {
  id        String    @id @default(cuid())
  userId    String
  loginAt   DateTime  @default(now())
  logoutAt  DateTime?
  ipAddress String?
  device    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([loginAt])
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * SUCURSALES / CAJA / HORARIOS
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */

model Branch {
  id        String   @id @default(cuid())
  name      String   @unique
  address   String?
  createdAt DateTime @default(now())

  users              User[]
  sales              Sale[]
  stocks             ProductStock[]
  cashRegisters      CashRegister[]
  inventoryMovements InventoryMovement[]
  variantStocks      VariantStock[]

  @@index([createdAt])
}

model WorkSchedule {
  id        String @id @default(cuid())
  userId    String
  dayOfWeek Int
  startTime String
  endTime   String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayOfWeek])
}

model CashRegister {
  id       String    @id @default(cuid())
  userId   String
  branchId String
  opening  Decimal   @db.Decimal(10, 2)
  closing  Decimal?  @db.Decimal(10, 2)
  openedAt DateTime  @default(now())
  closedAt DateTime?
  isOpen   Boolean   @default(true)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([branchId])
  @@index([userId])
  @@index([openedAt])
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * IMPUESTOS
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */

model Tax {
  id        String  @id @default(cuid())
  name      String
  rate      Decimal @db.Decimal(5, 2)
  isDefault Boolean @default(false)

  products Product[]

  @@unique([name, rate])
  @@index([isDefault])
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * CATEGORÃAS Y PRODUCTOS
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  color     String   @default("#3b82f6")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@index([createdAt])
}

model Product {
  id             String    @id @default(cuid())
  name           String
  price          Decimal   @db.Decimal(10, 2)
  costo          Decimal   @db.Decimal(10, 2)
  barcode        String?   @unique
  image          String?
  color          String    @default("#10b981")
  expirationDate DateTime?
  stockMinimo    Int?
  categoryId     String
  taxId          String?
  active         Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  category           Category            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  tax                Tax?                @relation(fields: [taxId], references: [id], onDelete: SetNull)
  variants           ProductVariant[]
  saleItems          SaleItem[]
  inventoryMovements InventoryMovement[]
  stocks             ProductStock[]
  notifications      Notification[]
  priceHistory       PriceHistory[]

  @@index([name])
  @@index([barcode])
  @@index([active])
  @@index([categoryId])
  @@index([expirationDate])
  @@index([createdAt])
}

model ProductVariant {
  id              String  @id @default(cuid())
  productId       String
  name            String
  value           String
  priceAdjustment Decimal @default(0)

  product            Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  stocks             VariantStock[]
  saleItems          SaleItem[] // ğŸ”¥ ahora conectado a ventas
  inventoryMovements InventoryMovement[]

  @@unique([productId, value])
  @@index([productId])
}

model VariantStock {
  id        String @id @default(cuid())
  variantId String
  branchId  String
  stock     Int    @default(0)

  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  branch  Branch         @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([variantId, branchId])
  @@index([branchId])
}

model ProductStock {
  id        String @id @default(cuid())
  productId String
  branchId  String
  stock     Int    @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  branch  Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([productId, branchId])
  @@index([branchId])
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * HISTORIAL DE PRECIOS
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */

model PriceHistory {
  id        String   @id @default(cuid())
  productId String
  oldPrice  Decimal  @db.Decimal(10, 2)
  newPrice  Decimal  @db.Decimal(10, 2)
  changedBy String?
  changedAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([changedAt])
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * INVENTARIO
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */

model InventoryMovement {
  id        String       @id @default(cuid())
  productId String
  variantId String?
  type      MovementType
  quantity  Int
  reason    String?
  userId    String
  branchId  String?
  createdAt DateTime     @default(now())

  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id])
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch  Branch?         @relation(fields: [branchId], references: [id], onDelete: SetNull)

  @@index([productId])
  @@index([variantId])
  @@index([userId])
  @@index([branchId])
  @@index([createdAt])
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * VENTAS
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */

model Sale {
  id            String        @id @default(cuid())
  userId        String
  branchId      String
  total         Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  cashAmount    Decimal?      @db.Decimal(10, 2)
  change        Decimal?      @db.Decimal(10, 2)
  mesa          Boolean       @default(false)
  mesaNumber    String?
  observaciones String?
  createdAt     DateTime      @default(now())

  user    User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch  Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  items   SaleItem[]
  invoice Invoice?

  @@index([branchId])
  @@index([userId])
  @@index([createdAt])
  @@index([branchId, createdAt])
}

model SaleItem {
  id        String  @id @default(cuid())
  saleId    String
  productId String
  variantId String? // ğŸ”¥ agregado
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  subtotal  Decimal @db.Decimal(10, 2)

  sale    Sale            @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([saleId])
  @@index([productId])
  @@index([variantId])
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * FACTURACIÃ“N
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */

model Invoice {
  id        String    @id @default(cuid())
  saleId    String    @unique
  number    String    @unique
  type      String
  cuit      String?
  cae       String?
  caeExpiry DateTime?
  createdAt DateTime  @default(now())

  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * NOTIFICACIONES / AUDITORÃA
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  productId String?
  userId    String?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([userId])
  @@index([productId])
  @@index([createdAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  entity    String
  entityId  String?
  action    String
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([entity])
  @@index([userId])
  @@index([createdAt])
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * CONFIGURACIÃ“N Y REPORTES
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Report {
  id          String   @id @default(cuid())
  type        String
  generatedAt DateTime @default(now())
  fileUrl     String?
  data        Json?
  userId      String?

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([generatedAt])
}
